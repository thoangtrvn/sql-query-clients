
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>cloud_utilities.aiops &#8212; SQLClient alpha documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/js/custom.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">SQLClient</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../includeme.html">README</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../utilities.html">ibmcloudsql.utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cos.html">ibmcloudsql.cos</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sql_magic.html">ibmcloudsql.sql_magic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sql_query.html">ibmcloudsql.sql_query</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">ibmcloudsql</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for cloud_utilities.aiops</h1><div class="highlight"><pre>
<span></span><span class="c1"># ------------------------------------------------------------------------------</span>
<span class="c1"># Copyright IBM Corp. 2020</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1"># ------------------------------------------------------------------------------</span>

<span class="kn">import</span> <span class="nn">ibmcloudsql</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">dateutil.parser</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.sql_query</span> <span class="kn">import</span> <span class="n">SQLClient</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sql_query</span> <span class="kn">import</span> <span class="n">SQLClient</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.sql_magic</span> <span class="kn">import</span>  <span class="n">print_sql</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">sql_magic</span> <span class="kn">import</span> <span class="n">print_sql</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">exceptions</span> <span class="kn">import</span> <span class="n">MaxRequestError</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.exceptions</span> <span class="kn">import</span> <span class="n">MaxRequestError</span>

<span class="kn">import</span> <span class="nn">functools</span>


<div class="viewcode-block" id="AIOpsSQLClient"><a class="viewcode-back" href="../../cloud_utilities.html#cloud_utilities.aiops.AIOpsSQLClient">[docs]</a><span class="k">class</span> <span class="nc">AIOpsSQLClient</span><span class="p">(</span><span class="n">SQLClient</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; PARQUET data</span>

<span class="sd">    If the parameters are missing, we can update using `configure` method</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    references to SQLClient class</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">cloud_apikey</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">sqlquery_instance_crn</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">cos_out_url</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">max_concurrent_jobs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                 <span class="n">client_info</span><span class="o">=</span><span class="s2">&quot;Testing&quot;</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">cloud_apikey</span><span class="o">=</span><span class="n">cloud_apikey</span><span class="p">,</span>
                         <span class="n">sqlquery_instance_crn</span><span class="o">=</span><span class="n">sqlquery_instance_crn</span><span class="p">,</span>
                         <span class="n">cos_out_url</span><span class="o">=</span><span class="n">cos_out_url</span><span class="p">,</span>
                         <span class="n">max_concurrent_jobs</span><span class="o">=</span><span class="n">max_concurrent_jobs</span><span class="p">,</span>
                         <span class="n">client_info</span><span class="o">=</span><span class="n">client_info</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cos_in_url</span> <span class="o">=</span> <span class="s2">&quot;cos://us-south/cos-analytics-parquet/AccessLogs/Location=eu-de/DC=rgfra02/gz_log_write_time=2019-10-23-13/Year=2019/Month=10/Day=23/&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cos_in_url_partitioned</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># &quot;cos://us-south/cos-analytics-parquet/AccessLogs&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">case</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># MUST use 0 now - choose 0, 1 or 2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cos_in_url_partitioned_case01</span> <span class="o">=</span> <span class="s2">&quot;cos://us-south/cos-analytics-parquet/AccessLogs&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cos_in_url_partitioned_case02</span> <span class="o">=</span> <span class="s2">&quot;cos://us-south/cos-analytics-parquet/AccessLogs/Location=</span><span class="si">{location}</span><span class="s2">/DC=</span><span class="si">{dc}</span><span class="s2">/&quot;</span>
        <span class="c1"># self.cos_in_url_template = &quot;cos://us-south/cos-analytics-parquet/AccessLogs/Location={location}/DC={dc}/gz_log_write_time={date_time}/Year={year}/Month={month}/Day={date}/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cos_in_url_template</span> <span class="o">=</span> <span class="s2">&quot;cos://us-south/cos-analytics-parquet/AccessLogs/Location=</span><span class="si">{location}</span><span class="s2">/DC=</span><span class="si">{dc}</span><span class="s2">/gz_log_write_time=</span><span class="si">{date_time}</span><span class="s2">/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sql_stmt_create_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE </span><span class="si">{table_name}</span><span class="s2"></span>
<span class="s2">        USING PARQUET</span>
<span class="s2">        LOCATION </span><span class="si">{cos_in}</span><span class="s2"></span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sql_stmt_show_temmplate</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SHOW TABLES</span>
<span class="s2">        INTO </span><span class="si">{cos_out}</span><span class="s2"> STORED AS CSV</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_columns_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;container_id&quot;</span><span class="p">,</span> <span class="s2">&quot;container_name&quot;</span><span class="p">,</span> <span class="s2">&quot;object_length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;request_method&quot;</span><span class="p">,</span> <span class="s2">&quot;request_latency&quot;</span><span class="p">,</span> <span class="s2">&quot;response_length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;storage_account_id&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp_start&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp_finish&quot;</span><span class="p">,</span>
            <span class="s2">&quot;user_agent&quot;</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">full_columns_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;bucket_protection&quot;</span><span class="p">,</span> <span class="s2">&quot;cloud_iam&quot;</span><span class="p">,</span> <span class="s2">&quot;cloud_iam_copy_source&quot;</span><span class="p">,</span>
            <span class="s2">&quot;container_bytes_used&quot;</span><span class="p">,</span> <span class="s2">&quot;container_id&quot;</span><span class="p">,</span> <span class="s2">&quot;container_name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;container_object_count&quot;</span><span class="p">,</span> <span class="s2">&quot;delete_marker&quot;</span><span class="p">,</span> <span class="s2">&quot;encryption_method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;error_code&quot;</span><span class="p">,</span> <span class="s2">&quot;error_message&quot;</span><span class="p">,</span> <span class="s2">&quot;format&quot;</span><span class="p">,</span> <span class="s2">&quot;forwarded&quot;</span><span class="p">,</span> <span class="s2">&quot;https&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ibm_account_id&quot;</span><span class="p">,</span> <span class="s2">&quot;interface_type&quot;</span><span class="p">,</span> <span class="s2">&quot;is_secure&quot;</span><span class="p">,</span> <span class="s2">&quot;last_changed&quot;</span><span class="p">,</span>
            <span class="s2">&quot;last_modified&quot;</span><span class="p">,</span> <span class="s2">&quot;may_contain_non_active_bytes&quot;</span><span class="p">,</span> <span class="s2">&quot;midstream_error&quot;</span><span class="p">,</span>
            <span class="s2">&quot;notification_sent&quot;</span><span class="p">,</span> <span class="s2">&quot;object_count&quot;</span><span class="p">,</span> <span class="s2">&quot;object_length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;object_lifecycle&quot;</span><span class="p">,</span> <span class="s2">&quot;object_name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;partial_storage_account_bytes_used&quot;</span><span class="p">,</span>
            <span class="s2">&quot;partial_storage_account_object_count&quot;</span><span class="p">,</span> <span class="s2">&quot;previous_last_modified&quot;</span><span class="p">,</span>
            <span class="s2">&quot;previous_object_length&quot;</span><span class="p">,</span> <span class="s2">&quot;principals&quot;</span><span class="p">,</span> <span class="s2">&quot;protocol&quot;</span><span class="p">,</span> <span class="s2">&quot;range&quot;</span><span class="p">,</span>
            <span class="s2">&quot;referer&quot;</span><span class="p">,</span> <span class="s2">&quot;remote_address&quot;</span><span class="p">,</span> <span class="s2">&quot;remote_user&quot;</span><span class="p">,</span> <span class="s2">&quot;remote_user_subject&quot;</span><span class="p">,</span>
            <span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="s2">&quot;request_latency&quot;</span><span class="p">,</span> <span class="s2">&quot;request_length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;request_method&quot;</span><span class="p">,</span> <span class="s2">&quot;request_type&quot;</span><span class="p">,</span> <span class="s2">&quot;request_uri&quot;</span><span class="p">,</span>
            <span class="s2">&quot;requested_location_constraint&quot;</span><span class="p">,</span> <span class="s2">&quot;response_length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;selective_logging_enabled&quot;</span><span class="p">,</span> <span class="s2">&quot;server_name&quot;</span><span class="p">,</span> <span class="s2">&quot;sse_kms&quot;</span><span class="p">,</span> <span class="s2">&quot;stat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;storage_account_id&quot;</span><span class="p">,</span> <span class="s2">&quot;storage_location_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;time_finish&quot;</span><span class="p">,</span> <span class="s2">&quot;time_start&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp_finish&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp_start&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;upload_id&quot;</span><span class="p">,</span> <span class="s2">&quot;user_agent&quot;</span><span class="p">,</span> <span class="s2">&quot;vault_name&quot;</span><span class="p">,</span> <span class="s2">&quot;version_name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;version_transient&quot;</span><span class="p">,</span> <span class="s2">&quot;accesser_log_filename&quot;</span><span class="p">,</span> <span class="s2">&quot;forwarded_for&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Time&quot;</span><span class="p">,</span> <span class="s2">&quot;Minute&quot;</span><span class="p">,</span> <span class="s2">&quot;Second&quot;</span><span class="p">,</span> <span class="s2">&quot;PreviousObjectLength&quot;</span><span class="p">,</span> <span class="s2">&quot;ObjectLength&quot;</span><span class="p">,</span>
            <span class="s2">&quot;AccountType&quot;</span><span class="p">,</span> <span class="s2">&quot;EndpointRegion&quot;</span><span class="p">,</span> <span class="s2">&quot;EndpointType&quot;</span>
        <span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;... AIOpsSQLClient created successful&quot;</span><span class="p">)</span>

    <span class="c1"># def query_by_date(self, sql_template, date_info, pagenumber=None):</span>
    <span class="c1">#     job_id = self.query_by_date_async(sql_template, date_info)</span>
    <span class="c1">#     _ = self.sqlClient.wait_for_job(job_id)</span>
    <span class="c1">#     # location = self.sqlClient.get_job(job_id)[&quot;resultset_location&quot;]</span>
    <span class="c1">#     return self.sqlClient.get_result(job_id, pagenumber)</span>

    <span class="c1"># def query_by_date_async(self, sql_template, date_info):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>

    <span class="c1">#     Parameters</span>
    <span class="c1">#     ----------</span>
    <span class="c1">#     sql_template: str</span>
    <span class="c1">#         As template SQL Query string with {cos_in} and {cos_out}</span>

    <span class="c1">#     date_info: str</span>
    <span class="c1">#         in YYYYMMDD format</span>

    <span class="c1">#     Returns</span>
    <span class="c1">#     -------</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     date = date_info[-2:]</span>
    <span class="c1">#     month = date_info[-4:-2]</span>
    <span class="c1">#     year = date_info[0:4]</span>
    <span class="c1">#     hours = [str(i).zfill(2) for i in range(1, 24)]</span>

    <span class="c1">#     delimiter = &quot;INTO&quot;</span>
    <span class="c1">#     pre, post = sql_template.split(delimiter, 1)</span>

    <span class="c1">#     post = &quot; &quot;.join([delimiter, post])</span>

    <span class="c1">#     mapping = {</span>
    <span class="c1">#         &quot;year&quot;: year,</span>
    <span class="c1">#         &quot;month&quot;: month,</span>
    <span class="c1">#         &quot;date&quot;: date,</span>
    <span class="c1">#         &quot;location&quot;: location,</span>
    <span class="c1">#         &quot;dc&quot;: DC,</span>
    <span class="c1">#         &quot;partitions&quot;: partitions,</span>
    <span class="c1">#         &quot;cos_out&quot;: cos_out,</span>
    <span class="c1">#         &quot;prefix_name&quot;: prefix_name,</span>
    <span class="c1">#         &quot;default_columns&quot;: default_columns</span>
    <span class="c1">#     }</span>

    <span class="c1">#     sql_stmt = &quot;&quot;</span>
    <span class="c1">#     index = 0</span>
    <span class="c1">#     for hour in hours:</span>
    <span class="c1">#         date_time = &quot;-&quot;.join([year, month, date, hour])</span>
    <span class="c1">#         cos_in = self.cos_in_url_template.format(date_time=date_time,</span>
    <span class="c1">#                                                  year=year,</span>
    <span class="c1">#                                                  month=month,</span>
    <span class="c1">#                                                  date=date)</span>
    <span class="c1">#         # sql_stmt = sql_template.format(cos_in=cos_in, cos_out=self.cos_out_url)</span>
    <span class="c1">#         if index == 0:</span>
    <span class="c1">#             sql_stmt = sql_stmt + pre.format(cos_in=cos_in,</span>
    <span class="c1">#                                              cos_out=self.cos_out_url)</span>
    <span class="c1">#         elif index &gt; 0:</span>
    <span class="c1">#             sql_stmt = sql_stmt + &quot;\nUNION\n&quot; + pre.format(</span>
    <span class="c1">#                 cos_in=cos_in, cos_out=self.cos_out_url)</span>
    <span class="c1">#         index = index + 1</span>

    <span class="c1">#     sql_stmt = sql_stmt + post</span>
    <span class="c1">#     logger.debug(sql_stmt)</span>
    <span class="c1">#     return self.sqlClient.submit_sql(sql_stmt)</span>

    <span class="k">def</span> <span class="nf">_copy_into_hive_partitions_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                       <span class="n">prefix_name</span><span class="p">,</span>
                                       <span class="n">cos_out_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                       <span class="n">columns_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                       <span class="n">except_columns_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                       <span class="n">year_month_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                       <span class="n">location</span><span class="o">=</span><span class="s2">&quot;eu-de&quot;</span><span class="p">,</span>
                                       <span class="n">DC</span><span class="o">=</span><span class="s2">&quot;rgfra02&quot;</span><span class="p">,</span>
                                       <span class="n">cos_in_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                       <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; date range</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        year_month_date : dict (key: year, value: dict (key=month, value: list of days)</span>
<span class="sd">            A dict</span>
<span class="sd">        cos_in_url : str, optional</span>
<span class="sd">            Use this only when we want to override the template-based COS URL of source data provided by</span>
<span class="sd">            `self.cos_in_url_template`</span>

<span class="sd">        todo</span>
<span class="sd">        ----</span>
<span class="sd">        implement this</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">year_month_date</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">year_month_date</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;wrong type of `year_month_date`&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">columns_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">columns_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_columns_list</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns_list</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">columns_list</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
                <span class="n">columns_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_columns_list</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">columns_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">columns_list</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">except_columns_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">except_columns_list</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">except_columns_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">except_columns_list</span><span class="p">]</span>
            <span class="n">columns_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">columns_list</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">except_columns_list</span>
            <span class="p">]</span>

        <span class="n">sql_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT </span><span class="si">{default_columns}</span><span class="s2">, </span><span class="si">{year}</span><span class="s2"> as Year, </span><span class="si">{month}</span><span class="s2"> as Month, </span><span class="si">{date}</span><span class="s2"> as Day, </span><span class="si">{hour}</span><span class="s2"> as Hour, &#39;</span><span class="si">{location}</span><span class="s2">&#39; as Location, &#39;</span><span class="si">{dc}</span><span class="s2">&#39; as DC</span>
<span class="s2">        FROM </span><span class="si">{cos_in}</span><span class="s2">  STORED AS PARQUET</span>
<span class="s2">        INTO </span><span class="si">{cos_out}</span><span class="s2">/</span><span class="si">{prefix_name}</span><span class="s2"> JOBPREFIX NONE STORED AS PARQUET</span>
<span class="s2">        PARTITIONED BY (</span><span class="si">{partitions}</span><span class="s2">) EVERY 1000000 ROWS</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">partition_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="s2">&quot;DC&quot;</span><span class="p">,</span> <span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="s2">&quot;Month&quot;</span><span class="p">,</span> <span class="s2">&quot;Day&quot;</span><span class="p">,</span> <span class="s2">&quot;Hour&quot;</span><span class="p">]</span>
        <span class="n">partitions</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">partition_list</span><span class="p">)</span>
        <span class="n">default_columns</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cos_out_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cos_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cos_out_url</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cos_out</span> <span class="o">=</span> <span class="n">cos_out_url</span>

        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># &quot;year&quot;: year,</span>
            <span class="c1"># &quot;month&quot;: month,</span>
            <span class="c1"># &quot;date&quot;: date,</span>
            <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">location</span><span class="p">,</span>
            <span class="s2">&quot;dc&quot;</span><span class="p">:</span> <span class="n">DC</span><span class="p">,</span>
            <span class="s2">&quot;partitions&quot;</span><span class="p">:</span> <span class="n">partitions</span><span class="p">,</span>
            <span class="s2">&quot;cos_out&quot;</span><span class="p">:</span> <span class="n">cos_out</span><span class="p">,</span>
            <span class="s2">&quot;prefix_name&quot;</span><span class="p">:</span> <span class="n">prefix_name</span><span class="p">,</span>
            <span class="s2">&quot;default_columns&quot;</span><span class="p">:</span> <span class="n">default_columns</span>
        <span class="p">}</span>

        <span class="n">delimiter</span> <span class="o">=</span> <span class="s2">&quot;INTO&quot;</span>
        <span class="n">pre</span><span class="p">,</span> <span class="n">post</span> <span class="o">=</span> <span class="n">sql_template</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">post</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">post</span><span class="p">])</span>
        <span class="n">post</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>

        <span class="n">single_query</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">single_query</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">sql_stmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">key_year</span><span class="p">,</span> <span class="n">val_year</span> <span class="ow">in</span> <span class="n">year_month_date</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">year</span> <span class="o">=</span> <span class="n">key_year</span>
                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">key_month</span><span class="p">,</span> <span class="n">val_month</span> <span class="ow">in</span> <span class="n">val_year</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">month</span> <span class="o">=</span> <span class="n">key_month</span>
                    <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

                    <span class="c1"># if isinstance(date_info, datetime.datetime):</span>
                    <span class="c1">#     mydate = date_info</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#     mydate = dateutil.parser.parse(date_info)</span>
                    <span class="c1"># hour = mydate.hour</span>
                    <span class="c1"># if hour == 0:</span>
                    <span class="c1">#     hours = [str(i).zfill(2) for i in range(1, 24)]</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#     hours = [str(hour).zfill(2)]</span>
                    <span class="n">hours</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">24</span><span class="p">)]</span>

                    <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">val_month</span><span class="p">:</span>
                        <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">hours</span><span class="p">:</span>
                            <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;hour&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                            <span class="n">date_time</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">hour</span><span class="p">])</span>
                            <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;date_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_time</span>
                            <span class="k">if</span> <span class="n">cos_in_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">cos_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cos_in_url_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">cos_in</span> <span class="o">=</span> <span class="n">cos_in_url</span>
                            <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;cos_in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos_in</span>
                            <span class="c1"># sql_stmt = sql_template.format(cos_in=cos_in, cos_out=self.cos_out_url)</span>
                            <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">sql_stmt</span> <span class="o">+</span> <span class="n">pre</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">sql_stmt</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">UNION</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">pre</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                            <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">sql_stmt</span> <span class="o">+</span> <span class="n">post</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="n">print_sql</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">submit_sql</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">stmts_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key_year</span><span class="p">,</span> <span class="n">val_year</span> <span class="ow">in</span> <span class="n">year_month_date</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">year</span> <span class="o">=</span> <span class="n">key_year</span>
                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">key_month</span><span class="p">,</span> <span class="n">val_month</span> <span class="ow">in</span> <span class="n">val_year</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">month</span> <span class="o">=</span> <span class="n">key_month</span>
                    <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

                    <span class="c1"># if isinstance(date_info, datetime.datetime):</span>
                    <span class="c1">#     mydate = date_info</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#     mydate = dateutil.parser.parse(date_info)</span>
                    <span class="c1"># hour = mydate.hour</span>
                    <span class="c1"># if hour == 0:</span>
                    <span class="c1">#     hours = [str(i).zfill(2) for i in range(1, 24)]</span>
                    <span class="c1"># else:</span>
                    <span class="c1">#     hours = [str(hour).zfill(2)]</span>
                    <span class="n">hours</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">24</span><span class="p">)]</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_month</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># multiple days - need to roll the data to reduce UNION count</span>
                        <span class="k">assert</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">pass</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">val_month</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">val_month</span><span class="p">:</span>
                            <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">hours</span><span class="p">:</span>
                                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;hour&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                                <span class="n">date_time</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">hour</span><span class="p">])</span>
                                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;date_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_time</span>
                                <span class="k">if</span> <span class="n">cos_in_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">cos_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cos_in_url_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">cos_in</span> <span class="o">=</span> <span class="n">cos_in_url</span>
                                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;cos_in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos_in</span>
                                <span class="c1"># sql_stmt = sql_template.format(cos_in=cos_in, cos_out=self.cos_out_url)</span>
                                <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">sql_stmt</span> <span class="o">+</span> <span class="n">pre</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                                <span class="k">elif</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">sql_stmt</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">UNION</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">pre</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                                <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">hours</span><span class="p">:</span>
                <span class="c1"># if index == 2:</span>
                <span class="c1">#     print(&quot;DEBUG: testing at from 00 to %s&quot; % hour)</span>
                <span class="c1">#     break  # early stop - DEBUG PURPOSE</span>
                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;hour&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hour</span>
                <span class="n">date_time</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">hour</span><span class="p">])</span>
                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;date_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_time</span>
                <span class="k">if</span> <span class="n">cos_in_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">cos_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cos_in_url_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cos_in</span> <span class="o">=</span> <span class="n">cos_in_url</span>
                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;cos_in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos_in</span>
                <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">pre</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">sql_stmt</span> <span class="o">+</span> <span class="n">post</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                <span class="n">stmts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                    <span class="n">print_sql</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">stmts_dequeue</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">(</span><span class="n">stmts_list</span><span class="p">)</span>
            <span class="n">sample_job_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">sleep_time</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># seconds</span>
            <span class="n">increment</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1">#6  # seconds</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">stmts_dequeue</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">stmts_dequeue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
                        <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_sql</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                        <span class="n">job_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
                        <span class="n">sample_job_id</span> <span class="o">=</span> <span class="n">job_id</span>
                    <span class="k">except</span> <span class="p">(</span><span class="n">MaxRequestError</span><span class="p">):</span>
                        <span class="n">stmts_dequeue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                        <span class="c1"># print(sleep_time)</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>  <span class="c1"># second</span>
                        <span class="k">if</span> <span class="n">sample_job_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">job_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">job_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">job_result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">]:</span>
                                <span class="n">delta</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                                    <span class="n">job_result</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">]</span>
                                <span class="p">)</span> <span class="o">-</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                                    <span class="n">job_result</span><span class="p">[</span><span class="s2">&quot;submit_time&quot;</span><span class="p">])</span>
                                <span class="n">sleep_time</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
                                <span class="n">sample_job_id</span> <span class="o">=</span> <span class="n">job_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sleep_time</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sleep_time</span> <span class="o">+</span> <span class="n">increment</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">job_ids</span>

    <span class="k">def</span> <span class="nf">_copy_into_hive_partitions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                   <span class="n">prefix_name</span><span class="p">,</span>
                                   <span class="n">cos_out_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">columns_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">except_columns_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">year_month_date</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">location</span><span class="o">=</span><span class="s2">&quot;eu-de&quot;</span><span class="p">,</span>
                                   <span class="n">DC</span><span class="o">=</span><span class="s2">&quot;rgfra02&quot;</span><span class="p">,</span>
                                   <span class="n">cos_in_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                   <span class="n">query_granularity</span><span class="o">=</span><span class="s2">&quot;wholeday&quot;</span><span class="p">,</span>
                                   <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; date range</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        year_month_date : dict (key: year, value: dict (key=month, value: list of days)</span>
<span class="sd">            A dict</span>
<span class="sd">        cos_in_url : str, optional</span>
<span class="sd">            Use this only when we want to override the template-based COS URL of source data provided by</span>
<span class="sd">            `self.cos_in_url_template`</span>

<span class="sd">        todo</span>
<span class="sd">        ----</span>
<span class="sd">        implement this</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">year_month_date</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">year_month_date</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;wrong type of `year_month_date`&quot;</span><span class="p">)</span>

        <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key_year</span><span class="p">,</span> <span class="n">val_year</span> <span class="ow">in</span> <span class="n">year_month_date</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">year</span> <span class="o">=</span> <span class="n">key_year</span>

            <span class="k">for</span> <span class="n">key_month</span><span class="p">,</span> <span class="n">val_month</span> <span class="ow">in</span> <span class="n">val_year</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">month</span> <span class="o">=</span> <span class="n">key_month</span>

                <span class="k">for</span> <span class="n">date</span> <span class="ow">in</span> <span class="n">val_month</span><span class="p">:</span>
                    <span class="n">date_info</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> \
                        <span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)])</span>
                    <span class="n">job_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">copy_into_hive_partitions_full_day</span><span class="p">(</span>
                            <span class="n">prefix_name</span><span class="p">,</span>
                            <span class="n">cos_out_url</span><span class="o">=</span><span class="n">cos_out_url</span><span class="p">,</span>
                            <span class="n">columns_list</span><span class="o">=</span><span class="n">columns_list</span><span class="p">,</span>
                            <span class="n">except_columns_list</span><span class="o">=</span><span class="n">except_columns_list</span><span class="p">,</span>
                            <span class="n">date_info</span><span class="o">=</span><span class="n">date_info</span><span class="p">,</span>
                            <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
                            <span class="n">DC</span><span class="o">=</span><span class="n">DC</span><span class="p">,</span>
                            <span class="n">query_granularity</span><span class="o">=</span><span class="n">query_granularity</span><span class="p">,</span>
                            <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">job_ids</span>

<div class="viewcode-block" id="AIOpsSQLClient.copy_into_hive_partitions_full_year"><a class="viewcode-back" href="../../cloud_utilities.html#cloud_utilities.aiops.AIOpsSQLClient.copy_into_hive_partitions_full_year">[docs]</a>    <span class="k">def</span> <span class="nf">copy_into_hive_partitions_full_year</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                            <span class="n">prefix_name</span><span class="p">,</span>
                                            <span class="n">cos_out_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                            <span class="n">columns_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                            <span class="n">except_columns_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                            <span class="n">date_info</span><span class="o">=</span><span class="s2">&quot;2020&quot;</span><span class="p">,</span>
                                            <span class="n">location</span><span class="o">=</span><span class="s2">&quot;eu-de&quot;</span><span class="p">,</span>
                                            <span class="n">DC</span><span class="o">=</span><span class="s2">&quot;rgfra02&quot;</span><span class="p">,</span>
                                            <span class="n">query_granularity</span><span class="o">=</span><span class="s2">&quot;wholeday&quot;</span><span class="p">,</span>
                                            <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; copy from either</span>

<span class="sd">        1. the beginning of the year (if only YYYY is available)</span>

<span class="sd">        2. the given day - if provided and ONLY when `cos_out_url` is in str format, e.g. &quot;20191020&quot;)</span>

<span class="sd">        until the end-of-year or now (whichever is the earlier)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        date_info: str | datetime.datetime</span>
<span class="sd">            In the form either &#39;YYYY&#39; or a datetime ISO standard form</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_from_given_day</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date_info</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="n">mydate</span> <span class="o">=</span> <span class="n">date_info</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">date_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">date_info</span> <span class="o">=</span> <span class="n">date_info</span><span class="o">+</span><span class="s2">&quot;0101&quot;</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">date_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">date_info</span> <span class="o">=</span> <span class="n">date_info</span> <span class="o">+</span> <span class="s2">&quot;01&quot;</span>
                <span class="n">mydate</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">date_info</span><span class="p">)</span>
                <span class="n">start_from_given_day</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
                <span class="n">mydate</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">date_info</span> <span class="o">+</span> <span class="s2">&quot;01&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start_from_given_day</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">start_day</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mydate</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start_day</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">start_day</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_day</span><span class="p">)</span>
        <span class="n">start_month</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mydate</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">year</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mydate</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

        <span class="n">max_month</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">max_year</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">max_day</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">year</span> <span class="o">&gt;</span> <span class="n">max_year</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">year</span> <span class="o">==</span> <span class="n">max_year</span> <span class="ow">and</span> <span class="n">start_month</span> <span class="o">&gt;</span> <span class="n">max_month</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

        <span class="n">year_month_date</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">val_year</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">year</span> <span class="o">&lt;</span> <span class="n">max_year</span><span class="p">:</span>
            <span class="n">max_month</span> <span class="o">=</span> <span class="mi">12</span>
        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">month</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">start_month</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_month</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">calendar</span> <span class="kn">import</span> <span class="n">monthrange</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">day_end</span> <span class="o">=</span> <span class="n">monthrange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">start_day</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">month</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_month</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_year</span><span class="p">):</span>
                <span class="n">day_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_day</span><span class="p">)</span>
            <span class="n">val_month</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_day</span><span class="p">,</span> <span class="n">day_end</span><span class="p">)]</span>
            <span class="n">val_year</span><span class="p">[</span><span class="n">month</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_month</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">year_month_date</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_year</span>
        <span class="n">job_id_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># import pprint</span>
        <span class="c1"># pprint.pprint(year_month_date)</span>
        <span class="c1"># return</span>
        <span class="n">job_id_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy_into_hive_partitions</span><span class="p">(</span>
            <span class="n">prefix_name</span><span class="p">,</span>
            <span class="n">cos_out_url</span><span class="o">=</span><span class="n">cos_out_url</span><span class="p">,</span>
            <span class="n">columns_list</span><span class="o">=</span><span class="n">columns_list</span><span class="p">,</span>
            <span class="n">except_columns_list</span><span class="o">=</span><span class="n">except_columns_list</span><span class="p">,</span>
            <span class="n">year_month_date</span><span class="o">=</span><span class="n">year_month_date</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
            <span class="n">DC</span><span class="o">=</span><span class="n">DC</span><span class="p">,</span>
            <span class="n">query_granularity</span><span class="o">=</span><span class="n">query_granularity</span><span class="p">,</span>
            <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">job_id_list</span></div>

<div class="viewcode-block" id="AIOpsSQLClient.copy_into_hive_partitions_full_month"><a class="viewcode-back" href="../../cloud_utilities.html#cloud_utilities.aiops.AIOpsSQLClient.copy_into_hive_partitions_full_month">[docs]</a>    <span class="k">def</span> <span class="nf">copy_into_hive_partitions_full_month</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                             <span class="n">prefix_name</span><span class="p">,</span>
                                             <span class="n">cos_out_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                             <span class="n">columns_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                             <span class="n">except_columns_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                             <span class="n">date_info</span><span class="o">=</span><span class="s2">&quot;201910&quot;</span><span class="p">,</span>
                                             <span class="n">location</span><span class="o">=</span><span class="s2">&quot;eu-de&quot;</span><span class="p">,</span>
                                             <span class="n">DC</span><span class="o">=</span><span class="s2">&quot;rgfra02&quot;</span><span class="p">,</span>
                                             <span class="n">query_granularity</span><span class="o">=</span><span class="s2">&quot;wholeday&quot;</span><span class="p">,</span>
                                             <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; copy from either</span>

<span class="sd">        1. the beginning of the month (if only YYYY and MM is available)</span>

<span class="sd">        2. the given day - if provided and ONLY when `cos_out_url` is in str format, e.g. &quot;20191020&quot;)</span>

<span class="sd">        until the end-of-month.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        date_info: str | datetime.datetime</span>
<span class="sd">            In the form either &#39;YYYYMM&#39; or &#39;YYYYMMDD&#39; or a datetime ISO standard form</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start_from_given_day</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date_info</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="n">mydate</span> <span class="o">=</span> <span class="n">date_info</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mydate</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">date_info</span><span class="p">)</span>
                <span class="n">start_from_given_day</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
                <span class="n">mydate</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">date_info</span> <span class="o">+</span> <span class="s2">&quot;01&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start_from_given_day</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">start_day</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mydate</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">start_day</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">start_day</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_day</span><span class="p">)</span>
        <span class="n">month</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mydate</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">year</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mydate</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">calendar</span> <span class="kn">import</span> <span class="n">monthrange</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">day_end</span> <span class="o">=</span> <span class="n">monthrange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">))</span>

        <span class="n">max_month</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">max_year</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">max_day</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">year</span> <span class="o">&gt;</span> <span class="n">max_year</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">year</span> <span class="o">==</span> <span class="n">max_year</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_month</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">year</span> <span class="o">==</span> <span class="n">max_year</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_month</span><span class="p">):</span>
            <span class="n">day_end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_day</span><span class="p">)</span>

        <span class="n">year_month_date</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">val_month</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_day</span><span class="p">,</span> <span class="n">day_end</span><span class="p">)]</span>
        <span class="n">val_year</span> <span class="o">=</span> <span class="p">{</span><span class="n">month</span><span class="p">:</span> <span class="n">val_month</span><span class="p">}</span>
        <span class="n">year_month_date</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_year</span>
        <span class="n">job_id_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># import pprint</span>
        <span class="c1"># pprint.pprint(year_month_date)</span>
        <span class="c1"># return</span>
        <span class="n">job_id_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy_into_hive_partitions</span><span class="p">(</span>
            <span class="n">prefix_name</span><span class="p">,</span>
            <span class="n">cos_out_url</span><span class="o">=</span><span class="n">cos_out_url</span><span class="p">,</span>
            <span class="n">columns_list</span><span class="o">=</span><span class="n">columns_list</span><span class="p">,</span>
            <span class="n">except_columns_list</span><span class="o">=</span><span class="n">except_columns_list</span><span class="p">,</span>
            <span class="n">year_month_date</span><span class="o">=</span><span class="n">year_month_date</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
            <span class="n">DC</span><span class="o">=</span><span class="n">DC</span><span class="p">,</span>
            <span class="n">query_granularity</span><span class="o">=</span><span class="n">query_granularity</span><span class="p">,</span>
            <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">job_id_list</span></div>

<div class="viewcode-block" id="AIOpsSQLClient.copy_into_hive_partitions_full_week"><a class="viewcode-back" href="../../cloud_utilities.html#cloud_utilities.aiops.AIOpsSQLClient.copy_into_hive_partitions_full_week">[docs]</a>    <span class="k">def</span> <span class="nf">copy_into_hive_partitions_full_week</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                            <span class="n">prefix_name</span><span class="p">,</span>
                                            <span class="n">cos_out_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                            <span class="n">columns_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                            <span class="n">except_columns_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                            <span class="n">date_info</span><span class="o">=</span><span class="s2">&quot;201910&quot;</span><span class="p">,</span>
                                            <span class="n">week_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                            <span class="n">location</span><span class="o">=</span><span class="s2">&quot;eu-de&quot;</span><span class="p">,</span>
                                            <span class="n">DC</span><span class="o">=</span><span class="s2">&quot;rgfra02&quot;</span><span class="p">,</span>
                                            <span class="n">query_granularity</span><span class="o">=</span><span class="s2">&quot;wholeday&quot;</span><span class="p">,</span>
                                            <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; copy from one week, i.e. 7-days, from</span>

<span class="sd">        1. a explicitly given start date - if provided and ONLY when `cos_out_url` is in str format, e.g. &quot;20191020&quot;)</span>
<span class="sd">        2. a implicitly given start date - by using `week_index`</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        week_index: int, optional</span>
<span class="sd">            A value should be in the range 1..4</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">week_length</span> <span class="o">=</span> <span class="mi">7</span>

        <span class="n">start_from_given_day</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date_info</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="n">mydate</span> <span class="o">=</span> <span class="n">date_info</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mydate</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">date_info</span><span class="p">)</span>
                <span class="n">start_from_given_day</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">_</span><span class="p">:</span>
                <span class="n">mydate</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">date_info</span> <span class="o">+</span> <span class="s2">&quot;01&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start_from_given_day</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">start_day</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mydate</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">week_index</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">week_index</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Provide at least a date in `date_info` or a week index in `week_index`&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">start_day</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">week_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">week_length</span>
        <span class="n">start_day</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">start_day</span><span class="p">)</span>
        <span class="n">month</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mydate</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">year</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mydate</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">calendar</span> <span class="kn">import</span> <span class="n">monthrange</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">day_end</span> <span class="o">=</span> <span class="n">monthrange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">year</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">month</span><span class="p">))</span>
        <span class="c1"># revise</span>
        <span class="n">day_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">day_end</span><span class="p">,</span> <span class="n">start_day</span> <span class="o">+</span> <span class="n">week_length</span><span class="p">)</span>

        <span class="n">year_month_date</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">val_month</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_day</span><span class="p">,</span> <span class="n">day_end</span><span class="p">)]</span>
        <span class="n">val_year</span> <span class="o">=</span> <span class="p">{</span><span class="n">month</span><span class="p">:</span> <span class="n">val_month</span><span class="p">}</span>
        <span class="n">year_month_date</span><span class="p">[</span><span class="n">year</span><span class="p">]</span> <span class="o">=</span> <span class="n">val_year</span>
        <span class="n">job_id_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">job_id_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy_into_hive_partitions</span><span class="p">(</span>
            <span class="n">prefix_name</span><span class="p">,</span>
            <span class="n">cos_out_url</span><span class="o">=</span><span class="n">cos_out_url</span><span class="p">,</span>
            <span class="n">columns_list</span><span class="o">=</span><span class="n">columns_list</span><span class="p">,</span>
            <span class="n">except_columns_list</span><span class="o">=</span><span class="n">except_columns_list</span><span class="p">,</span>
            <span class="n">year_month_date</span><span class="o">=</span><span class="n">year_month_date</span><span class="p">,</span>
            <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span>
            <span class="n">DC</span><span class="o">=</span><span class="n">DC</span><span class="p">,</span>
            <span class="n">query_granularity</span><span class="o">=</span><span class="n">query_granularity</span><span class="p">,</span>
            <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">job_id_list</span></div>

<div class="viewcode-block" id="AIOpsSQLClient.copy_into_hive_partitions_full_day_test"><a class="viewcode-back" href="../../cloud_utilities.html#cloud_utilities.aiops.AIOpsSQLClient.copy_into_hive_partitions_full_day_test">[docs]</a>    <span class="k">def</span> <span class="nf">copy_into_hive_partitions_full_day_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                <span class="n">prefix_name</span><span class="p">,</span>
                                                <span class="n">cos_out_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                <span class="n">columns_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                <span class="n">except_columns_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                <span class="n">date_info</span><span class="o">=</span><span class="s2">&quot;20191023&quot;</span><span class="p">,</span>
                                                <span class="n">location</span><span class="o">=</span><span class="s2">&quot;eu-de&quot;</span><span class="p">,</span>
                                                <span class="n">DC</span><span class="o">=</span><span class="s2">&quot;rgfra02&quot;</span><span class="p">,</span>
                                                <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; first hour (1st) of the day to the end (23rd)</span>

<span class="sd">        Notes</span>
<span class="sd">        -------</span>
<span class="sd">        currently: we start with cos://my-cos/my-bucket/prefix/</span>

<span class="sd">        1. add missing column (Location, Year, Month) to data so that it can be partitioned using these columns,</span>
<span class="sd">        2. and let the system add /Location=eu-de/Year=2019/Month=10/Day=23 before adding the parquet data</span>

<span class="sd">        The problem with this: we cannot apply NOJOBPREFIX as it will wipe out from</span>

<span class="sd">        .. code-block:: console</span>

<span class="sd">            cos://my-cos/my-bucket/prefix/</span>

<span class="sd">        instead of adding the column so that it can be partitioned, we</span>
<span class="sd">        start with</span>

<span class="sd">        .. code-block:: console</span>

<span class="sd">            cos://my-cos/my-bucket/prefix/Location=eu-de/Year=2019/Month=10/Day=23/</span>

<span class="sd">        and create the prefix</span>
<span class="sd">        --&gt; so that JOBNOPREFIX is applied at the deeper path</span>

<span class="sd">        Parameters</span>
<span class="sd">        --------------</span>
<span class="sd">        prefix_name: str</span>
<span class="sd">            the prefix to be used, e.g. cos://&lt;cos-name&gt;/&lt;bucket&gt;/&lt;path&gt;/&lt;prefix-name&gt;</span>

<span class="sd">        cos_out_url : str, optional</span>
<span class="sd">            The COS URL where the data should be copied to, cos://&lt;cos-name&gt;/&lt;bucket&gt;/&lt;path&gt;</span>
<span class="sd">            If omitted, we use self.cos_out_url</span>

<span class="sd">        columns_list : str | list, optional</span>
<span class="sd">            The single column name or a list of columns to be copied</span>
<span class="sd">            NOTE: Use &#39;*&#39; to indicate all columns</span>
<span class="sd">            (default) those defined internally `self.default_columns_list`</span>

<span class="sd">        except_columns_list: str | list, optional</span>
<span class="sd">            A name or a list of column names to be excluded</span>
<span class="sd">            NOTE: Use this wisely with `columns_list` parameter</span>

<span class="sd">        date_info: str or datetime.datetime</span>
<span class="sd">            * string type: example string format: YYYYMMDD - what date to copy to COS URL output</span>

<span class="sd">            You can also use any accepting format by `dateutil &lt;https://dateutil.readthedocs.io/en/stable/parser.html&gt;` package.</span>
<span class="sd">            Example: &quot;2012-01-22 10PM&quot;</span>

<span class="sd">            * datetime.datetime type:</span>
<span class="sd">                `example &lt;https://dateutil.readthedocs.io/en/stable/examples.html&gt;`_</span>

<span class="sd">            IMPORTANT: A full day scan is used if there is no &#39;hour&#39; provided, or &#39;hour = 0&#39;</span>

<span class="sd">        location : str</span>
<span class="sd">            location to copy</span>

<span class="sd">        dry_run : bool, optional</span>
<span class="sd">            If True, then does not do any real query [for testing purpose]</span>

<span class="sd">        Returns</span>
<span class="sd">        ---------</span>
<span class="sd">        list</span>
<span class="sd">            A list of job_id</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if isinstance(locations, str):</span>
        <span class="c1">#     locations = [locations]</span>

        <span class="k">if</span> <span class="n">columns_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">columns_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_columns_list</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns_list</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">columns_list</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
                <span class="n">columns_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_columns_list</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">columns_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">columns_list</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">except_columns_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">except_columns_list</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">except_columns_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">except_columns_list</span><span class="p">]</span>
            <span class="n">columns_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">columns_list</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">except_columns_list</span>
            <span class="p">]</span>

        <span class="n">partition_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="s2">&quot;DC&quot;</span><span class="p">,</span> <span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="s2">&quot;Month&quot;</span><span class="p">,</span> <span class="s2">&quot;Day&quot;</span><span class="p">,</span> <span class="s2">&quot;Hour&quot;</span><span class="p">]</span>
        <span class="n">partitions</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">partition_list</span><span class="p">)</span>
        <span class="n">default_columns</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns_list</span><span class="p">)</span>
        <span class="c1"># must match the order above</span>
        <span class="n">path_name_template</span> <span class="o">=</span> <span class="s2">&quot;Location=</span><span class="si">{location}</span><span class="s2">/DC=</span><span class="si">{dc}</span><span class="s2">/Year=</span><span class="si">{year}</span><span class="s2">/Month=</span><span class="si">{month}</span><span class="s2">/Day=</span><span class="si">{date}</span><span class="s2">/Hour=</span><span class="si">{hour}</span><span class="s2">&quot;</span>

        <span class="c1">#Choose this</span>
        <span class="n">single_query</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">single_query</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">sql_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT </span><span class="si">{default_columns}</span><span class="s2">, </span><span class="si">{year}</span><span class="s2"> as Year, </span><span class="si">{month}</span><span class="s2"> as Month, </span><span class="si">{date}</span><span class="s2"> as Day, </span><span class="si">{hour}</span><span class="s2"> as Hour, &#39;</span><span class="si">{location}</span><span class="s2">&#39; as Location, &#39;</span><span class="si">{dc}</span><span class="s2">&#39; as DC</span>
<span class="s2">            FROM </span><span class="si">{cos_in}</span><span class="s2">  STORED AS PARQUET</span>
<span class="s2">            INTO </span><span class="si">{cos_out}</span><span class="s2">/</span><span class="si">{prefix_name}</span><span class="s2"> JOBPREFIX NONE STORED AS PARQUET</span>
<span class="s2">            PARTITIONED BY (</span><span class="si">{partitions}</span><span class="s2">) EVERY 1000000 ROWS</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">default_except_columns_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="s2">&quot;DC&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">except_columns_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">except_columns_list</span> <span class="o">=</span> <span class="n">default_except_columns_list</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">except_columns_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">default_except_columns_list</span><span class="p">)</span>

            <span class="s2">&quot; Columns to be dropped from objects: Location, DC&quot;</span>
            <span class="s2">&quot;</span><span class="si">{year}</span><span class="s2"> as Year, </span><span class="si">{month}</span><span class="s2"> as Month, </span><span class="si">{date}</span><span class="s2"> as Day, </span><span class="si">{hour}</span><span class="s2"> as Hour, &#39;</span><span class="si">{location}</span><span class="s2">&#39; as Location, &#39;</span><span class="si">{dc}</span><span class="s2">&#39; as DC&quot;</span>
            <span class="n">sql_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT </span><span class="si">{default_columns}</span><span class="s2"></span>
<span class="s2">            FROM </span><span class="si">{cos_in}</span><span class="s2">  STORED AS PARQUET</span>
<span class="s2">            INTO </span><span class="si">{cos_out}</span><span class="s2">/</span><span class="si">{prefix_name}</span><span class="s2">/</span><span class="si">{path_name}</span><span class="s2">/ JOBPREFIX NONE STORED AS PARQUET</span>
<span class="s2">            &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date_info</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="n">mydate</span> <span class="o">=</span> <span class="n">date_info</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mydate</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">date_info</span><span class="p">)</span>
        <span class="c1"># date = date_info[-2:]</span>
        <span class="c1"># month = date_info[-4:-2]</span>
        <span class="c1"># year = date_info[0:4]</span>
        <span class="n">date</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mydate</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">month</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mydate</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">year</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mydate</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">hour</span> <span class="o">=</span> <span class="n">mydate</span><span class="o">.</span><span class="n">hour</span>
        <span class="k">if</span> <span class="n">hour</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">hours</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">24</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hours</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">cos_out_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cos_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cos_out_url</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cos_out</span> <span class="o">=</span> <span class="n">cos_out_url</span>

        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">year</span><span class="p">,</span>
            <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">month</span><span class="p">,</span>
            <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
            <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">location</span><span class="p">,</span>
            <span class="s2">&quot;dc&quot;</span><span class="p">:</span> <span class="n">DC</span><span class="p">,</span>
            <span class="s2">&quot;partitions&quot;</span><span class="p">:</span> <span class="n">partitions</span><span class="p">,</span>
            <span class="s2">&quot;cos_out&quot;</span><span class="p">:</span> <span class="n">cos_out</span><span class="p">,</span>
            <span class="s2">&quot;prefix_name&quot;</span><span class="p">:</span> <span class="n">prefix_name</span><span class="p">,</span>
            <span class="s2">&quot;default_columns&quot;</span><span class="p">:</span> <span class="n">default_columns</span>
        <span class="p">}</span>

        <span class="n">delimiter</span> <span class="o">=</span> <span class="s2">&quot;INTO&quot;</span>
        <span class="n">pre</span><span class="p">,</span> <span class="n">post</span> <span class="o">=</span> <span class="n">sql_template</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">post_template</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">post</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">single_query</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">post</span> <span class="o">=</span> <span class="n">post_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
            <span class="n">sql_stmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">hours</span><span class="p">:</span>
                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;hour&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hour</span>
                <span class="n">date_time</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">hour</span><span class="p">])</span>
                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;date_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_time</span>
                <span class="n">cos_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cos_in_url_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;cos_in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos_in</span>
                <span class="c1"># sql_stmt = sql_template.format(cos_in=cos_in, cos_out=self.cos_out_url)</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">sql_stmt</span> <span class="o">+</span> <span class="n">pre</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">sql_stmt</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">UNION</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">pre</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">sql_stmt</span> <span class="o">+</span> <span class="n">post</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="n">print_sql</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">submit_sql</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">stmts_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">hours</span><span class="p">:</span>
                <span class="c1"># if index == 2:</span>
                <span class="c1">#     print(&quot;DEBUG: testing at from 00 to %s&quot; % hour)</span>
                <span class="c1">#     break  # early stop - DEBUG PURPOSE</span>
                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;hour&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hour</span>
                <span class="n">date_time</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">hour</span><span class="p">])</span>
                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;date_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_time</span>
                <span class="n">cos_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cos_in_url_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;cos_in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos_in</span>
                <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">pre</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                <span class="n">path_name</span> <span class="o">=</span> <span class="n">path_name_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                <span class="n">post</span> <span class="o">=</span> <span class="n">post_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">,</span> <span class="n">path_name</span><span class="o">=</span><span class="n">path_name</span><span class="p">)</span>
                <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">sql_stmt</span> <span class="o">+</span> <span class="n">post</span>

                <span class="c1"># delete existing data first</span>
                <span class="c1"># todo  - fix this to delete existing data</span>
                <span class="c1"># cos_url = &quot;{cos_out}/{prefix_name}/{path_name}/&quot;.format(**mapping, path_name=path_name)</span>
                <span class="c1"># self.delete_objects(cos_url)</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                <span class="n">stmts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                    <span class="n">print_sql</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">stmts_dequeue</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">(</span><span class="n">stmts_list</span><span class="p">)</span>
            <span class="n">sample_job_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">sleep_time</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># seconds</span>
            <span class="n">increment</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1">#6  # seconds</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">stmts_dequeue</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">stmts_dequeue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
                        <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_sql</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                        <span class="n">job_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
                        <span class="n">sample_job_id</span> <span class="o">=</span> <span class="n">job_id</span>
                    <span class="k">except</span> <span class="p">(</span><span class="n">MaxRequestError</span><span class="p">):</span>
                        <span class="n">stmts_dequeue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                        <span class="c1"># print(sleep_time)</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>  <span class="c1"># second</span>
                        <span class="k">if</span> <span class="n">sample_job_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">job_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">job_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">job_result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">]:</span>
                                <span class="n">delta</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                                    <span class="n">job_result</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">]</span>
                                <span class="p">)</span> <span class="o">-</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                                    <span class="n">job_result</span><span class="p">[</span><span class="s2">&quot;submit_time&quot;</span><span class="p">])</span>
                                <span class="n">sleep_time</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
                                <span class="n">sample_job_id</span> <span class="o">=</span> <span class="n">job_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sleep_time</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sleep_time</span> <span class="o">+</span> <span class="n">increment</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">job_ids</span></div>

<div class="viewcode-block" id="AIOpsSQLClient.copy_into_hive_partitions_full_day"><a class="viewcode-back" href="../../cloud_utilities.html#cloud_utilities.aiops.AIOpsSQLClient.copy_into_hive_partitions_full_day">[docs]</a>    <span class="k">def</span> <span class="nf">copy_into_hive_partitions_full_day</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                           <span class="n">prefix_name</span><span class="p">,</span>
                                           <span class="n">cos_out_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                           <span class="n">columns_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                           <span class="n">except_columns_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                           <span class="n">date_info</span><span class="o">=</span><span class="s2">&quot;20191023&quot;</span><span class="p">,</span>
                                           <span class="n">location</span><span class="o">=</span><span class="s2">&quot;eu-de&quot;</span><span class="p">,</span>
                                           <span class="n">DC</span><span class="o">=</span><span class="s2">&quot;rgfra02&quot;</span><span class="p">,</span>
                                           <span class="n">query_granularity</span><span class="o">=</span><span class="s2">&quot;wholeday&quot;</span><span class="p">,</span>
                                           <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; copy data from either</span>

<span class="sd">        1. the given hour (if given) or</span>

<span class="sd">        2. the first hour (1st) of the day</span>

<span class="sd">        to the end (23rd)</span>

<span class="sd">        Hour is based on logfile-written time</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        prefix_name: str</span>
<span class="sd">            the prefix to be used when storing the data, e.g.</span>

<span class="sd">                `cos://&lt;cos-name&gt;/&lt;bucket&gt;[/&lt;path&gt;]/&lt;prefix-name&gt;`</span>

<span class="sd">        cos_out_url : str, optional</span>
<span class="sd">            The COS URL where the data should be copied to,</span>

<span class="sd">                `cos://&lt;cos-name&gt;/&lt;bucket&gt;[/&lt;path&gt;]`</span>

<span class="sd">            If omitted, we use self.cos_out_url</span>

<span class="sd">        columns_list : str | list, optional</span>
<span class="sd">            The single column name or a list of columns to be copied</span>
<span class="sd">            NOTE: Use &#39;*&#39; to indicate all columns</span>
<span class="sd">            (default) those defined internally `self.default_columns_list`</span>

<span class="sd">        except_columns_list: str | list, optional</span>
<span class="sd">            A name or a list of column names to be excluded</span>
<span class="sd">            NOTE: Use this wisely with `columns_list` parameter</span>

<span class="sd">        date_info: str or datetime.datetime</span>
<span class="sd">            * string type: example string format: YYYYMMDD - what date to copy to COS URL output</span>

<span class="sd">                You can also use any accepting format by `dateutil &lt;https://dateutil.readthedocs.io/en/stable/parser.html&gt;`_ package.</span>
<span class="sd">                Example: &quot;2012-01-22 10PM&quot;</span>

<span class="sd">            * datetime.datetime type:</span>
<span class="sd">                `example &lt;https://dateutil.readthedocs.io/en/stable/examples.html&gt;`_</span>

<span class="sd">            IMPORTANT: A full day scan is used if there is no &#39;hour&#39; provided, or &#39;hour = 0&#39;</span>

<span class="sd">        location : str</span>
<span class="sd">            location to copy</span>

<span class="sd">        query_granularity: str</span>
<span class="sd">            A value in the list [&quot;halfday&quot;, &quot;perhour&quot;, &quot;wholeday&quot;]</span>

<span class="sd">            * wholeday = single query</span>
<span class="sd">            * perhour  = 24 separate queries</span>
<span class="sd">            * halfhour = 2 separate queries</span>

<span class="sd">            This is designed to handle with max-query time limit</span>

<span class="sd">        dry_run : bool, optional</span>
<span class="sd">            If True, then does not do any real query [for testing purpose]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            A list of job_id</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if isinstance(locations, str):</span>
        <span class="c1">#     locations = [locations]</span>

        <span class="k">if</span> <span class="n">columns_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">columns_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_columns_list</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns_list</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">columns_list</span> <span class="o">==</span> <span class="s2">&quot;*&quot;</span><span class="p">:</span>
                <span class="n">columns_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_columns_list</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">columns_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">columns_list</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">except_columns_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">except_columns_list</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">except_columns_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">except_columns_list</span><span class="p">]</span>
            <span class="n">columns_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">columns_list</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">except_columns_list</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date_info</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="n">mydate</span> <span class="o">=</span> <span class="n">date_info</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mydate</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">date_info</span><span class="p">)</span>
        <span class="n">min_num_digit</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">date</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mydate</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">min_num_digit</span><span class="p">)</span>
        <span class="n">month</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mydate</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">min_num_digit</span><span class="p">)</span>
        <span class="n">year</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mydate</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">min_num_digit</span><span class="p">)</span>
        <span class="n">hour</span> <span class="o">=</span> <span class="n">mydate</span><span class="o">.</span><span class="n">hour</span>
        <span class="k">if</span> <span class="n">hour</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">hours</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">min_num_digit</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">24</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hours</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">min_num_digit</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">query_granularity</span> <span class="o">==</span> <span class="s2">&quot;wholeday&quot;</span><span class="p">:</span>
            <span class="n">partition_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Hour&quot;</span><span class="p">]</span>
            <span class="c1"># must match the order above</span>
            <span class="n">path_name_template</span> <span class="o">=</span> <span class="s2">&quot;Location=</span><span class="si">{location}</span><span class="s2">/DC=</span><span class="si">{dc}</span><span class="s2">/Year=</span><span class="si">{year}</span><span class="s2">/Month=</span><span class="si">{month}</span><span class="s2">/Day=</span><span class="si">{date}</span><span class="s2">&quot;</span>
            <span class="n">sql_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT </span><span class="si">{default_columns}</span><span class="s2">, </span><span class="si">{hour}</span><span class="s2"> as Hour, date_format(Time,&#39;H a&#39;) AS HalfDay</span>
<span class="s2">            FROM </span><span class="si">{cos_in}</span><span class="s2">  STORED AS PARQUET</span>
<span class="s2">            INTO </span><span class="si">{cos_out}</span><span class="s2">/</span><span class="si">{prefix_name}</span><span class="s2">/</span><span class="si">{path_name}</span><span class="s2">/ JOBPREFIX NONE STORED AS PARQUET</span>
<span class="s2">            PARTITIONED BY (</span><span class="si">{partitions}</span><span class="s2">) EVERY 1000000 ROWS</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">partition_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;HalfDay&quot;</span><span class="p">,</span> <span class="s2">&quot;Hour&quot;</span><span class="p">]</span>
            <span class="c1"># must match the order above</span>
            <span class="n">path_name_template</span> <span class="o">=</span> <span class="s2">&quot;Location=</span><span class="si">{location}</span><span class="s2">/DC=</span><span class="si">{dc}</span><span class="s2">/Year=</span><span class="si">{year}</span><span class="s2">/Month=</span><span class="si">{month}</span><span class="s2">/Day=</span><span class="si">{date}</span><span class="s2">&quot;</span>
            <span class="c1">##</span>
            <span class="c1"># --&gt; here we use the event-time</span>
            <span class="c1"># SELECT {default_columns}, {hour} as Hour, date_format(Time,&#39;H a&#39;) AS HalfDay</span>
            <span class="c1"># --&gt; here we use the log-time</span>
            <span class="c1"># SELECT {default_columns}, {hour} as Hour, {halfday} AS HalfDay</span>
            <span class="n">sql_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            SELECT </span><span class="si">{default_columns}</span><span class="s2">, </span><span class="si">{hour}</span><span class="s2"> as Hour, &#39;</span><span class="si">{halfday}</span><span class="s2">&#39; AS HalfDay</span>
<span class="s2">            FROM </span><span class="si">{cos_in}</span><span class="s2">  STORED AS PARQUET</span>
<span class="s2">            INTO </span><span class="si">{cos_out}</span><span class="s2">/</span><span class="si">{prefix_name}</span><span class="s2">/</span><span class="si">{path_name}</span><span class="s2">/ JOBPREFIX NONE STORED AS PARQUET</span>
<span class="s2">            PARTITIONED BY (</span><span class="si">{partitions}</span><span class="s2">) EVERY 1000000 ROWS</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="n">partitions</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">partition_list</span><span class="p">)</span>
        <span class="n">default_columns</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">columns_list</span><span class="p">)</span>
        <span class="c1"># here is the name of columns currently in the data, and should be removed as they are now</span>
        <span class="c1"># part of the path to be used in HIVE-partition</span>
        <span class="c1"># todo: enable below</span>
        <span class="n">default_except_columns_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="s2">&quot;DC&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">except_columns_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">except_columns_list</span> <span class="o">=</span> <span class="n">default_except_columns_list</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">except_columns_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">default_except_columns_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cos_out_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cos_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cos_out_url</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cos_out</span> <span class="o">=</span> <span class="n">cos_out_url</span>

        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="n">year</span><span class="p">,</span>
            <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="n">month</span><span class="p">,</span>
            <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span>
            <span class="s2">&quot;location&quot;</span><span class="p">:</span> <span class="n">location</span><span class="p">,</span>
            <span class="s2">&quot;dc&quot;</span><span class="p">:</span> <span class="n">DC</span><span class="p">,</span>
            <span class="s2">&quot;partitions&quot;</span><span class="p">:</span> <span class="n">partitions</span><span class="p">,</span>
            <span class="s2">&quot;cos_out&quot;</span><span class="p">:</span> <span class="n">cos_out</span><span class="p">,</span>
            <span class="s2">&quot;prefix_name&quot;</span><span class="p">:</span> <span class="n">prefix_name</span><span class="p">,</span>
            <span class="s2">&quot;default_columns&quot;</span><span class="p">:</span> <span class="n">default_columns</span>
        <span class="p">}</span>

        <span class="n">delimiter</span> <span class="o">=</span> <span class="s2">&quot;INTO&quot;</span>
        <span class="n">pre</span><span class="p">,</span> <span class="n">post</span> <span class="o">=</span> <span class="n">sql_template</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">delimiter</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">post_template</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">post</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">query_granularity</span> <span class="o">==</span> <span class="s2">&quot;wholeday&quot;</span><span class="p">:</span>
            <span class="n">path_name</span> <span class="o">=</span> <span class="n">path_name_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
            <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;path_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_name</span>
            <span class="n">post</span> <span class="o">=</span> <span class="n">post_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
            <span class="n">sql_stmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">hours</span><span class="p">:</span>
                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;hour&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hour</span>
                <span class="n">date_time</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">hour</span><span class="p">])</span>
                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;date_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_time</span>
                <span class="n">cos_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cos_in_url_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;cos_in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos_in</span>
                <span class="c1"># sql_stmt = sql_template.format(cos_in=cos_in, cos_out=self.cos_out_url)</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">sql_stmt</span> <span class="o">+</span> <span class="n">pre</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">sql_stmt</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">UNION</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">pre</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">sql_stmt</span> <span class="o">+</span> <span class="n">post</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="n">print_sql</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># return [self.submit_sql(sql_stmt)]</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">submit_sql_with_checking_saved_jobs</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="n">query_granularity</span> <span class="o">==</span> <span class="s2">&quot;halfday&quot;</span><span class="p">:</span>
            <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sql_stmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">prev_hour</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">hours</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">12</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">prev_hour</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">:</span>
                    <span class="n">issue_query</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">issue_query</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">prev_hour</span> <span class="o">=</span> <span class="n">hour</span>
                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;hour&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hour</span>
                <span class="n">date_time</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">hour</span><span class="p">])</span>
                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;date_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_time</span>
                <span class="n">cos_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cos_in_url_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;cos_in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos_in</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
                    <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;halfday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PM&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;halfday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;AM&quot;</span>
                <span class="n">path_name</span> <span class="o">=</span> <span class="n">path_name_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;path_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_name</span>
                <span class="n">post</span> <span class="o">=</span> <span class="n">post_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                <span class="c1"># sql_stmt = sql_template.format(cos_in=cos_in, cos_out=self.cos_out_url)</span>
                <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">sql_stmt</span> <span class="o">+</span> <span class="n">pre</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">sql_stmt</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">UNION</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">pre</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">issue_query</span><span class="p">:</span>
                    <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">sql_stmt</span> <span class="o">+</span> <span class="n">post</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                    <span class="c1"># reset</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                        <span class="n">print_sql</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NEXT</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># job_ids.append(self.submit_sql(sql_stmt))</span>
                        <span class="n">job_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">submit_sql_with_checking_saved_jobs</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">))</span>
                    <span class="n">sql_stmt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">sql_stmt</span> <span class="o">+</span> <span class="n">post</span>
            <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="n">print_sql</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># job_ids.append(self.submit_sql(sql_stmt))</span>
                <span class="n">job_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">submit_sql_with_checking_saved_jobs</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">job_ids</span>
        <span class="k">elif</span> <span class="n">query_granularity</span> <span class="o">==</span> <span class="s2">&quot;perhour&quot;</span><span class="p">:</span>
            <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">stmts_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">hours</span><span class="p">:</span>
                <span class="c1"># if index == 2:</span>
                <span class="c1">#     print(&quot;DEBUG: testing at from 00 to %s&quot; % hour)</span>
                <span class="c1">#     break  # early stop - DEBUG PURPOSE</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
                    <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;halfday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PM&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;halfday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;AM&quot;</span>
                <span class="n">path_name</span> <span class="o">=</span> <span class="n">path_name_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;path_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path_name</span>
                <span class="n">post</span> <span class="o">=</span> <span class="n">post_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;hour&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hour</span>
                <span class="n">date_time</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">hour</span><span class="p">])</span>
                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;date_time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_time</span>
                <span class="n">cos_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cos_in_url_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                <span class="n">mapping</span><span class="p">[</span><span class="s2">&quot;cos_in&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cos_in</span>
                <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">pre</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
                <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">sql_stmt</span> <span class="o">+</span> <span class="n">post</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                <span class="n">stmts_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
                    <span class="n">print_sql</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                <span class="n">index</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">stmts_dequeue</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">(</span><span class="n">stmts_list</span><span class="p">)</span>
            <span class="n">sample_job_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">sleep_time</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># seconds</span>
            <span class="n">increment</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1">#6  # seconds</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
                <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">stmts_dequeue</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">sql_stmt</span> <span class="o">=</span> <span class="n">stmts_dequeue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
                        <span class="c1"># job_id = self.submit_sql(sql_stmt)</span>
                        <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_sql_with_checking_saved_jobs</span><span class="p">(</span>
                            <span class="n">sql_stmt</span><span class="p">)</span>
                        <span class="n">job_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
                        <span class="n">sample_job_id</span> <span class="o">=</span> <span class="n">job_id</span>
                    <span class="k">except</span> <span class="p">(</span><span class="n">MaxRequestError</span><span class="p">):</span>
                        <span class="n">stmts_dequeue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sql_stmt</span><span class="p">)</span>
                        <span class="c1"># print(sleep_time)</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>  <span class="c1"># second</span>
                        <span class="k">if</span> <span class="n">sample_job_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">job_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span><span class="n">job_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">job_result</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">]:</span>
                                <span class="n">delta</span> <span class="o">=</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                                    <span class="n">job_result</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">]</span>
                                <span class="p">)</span> <span class="o">-</span> <span class="n">dateutil</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
                                    <span class="n">job_result</span><span class="p">[</span><span class="s2">&quot;submit_time&quot;</span><span class="p">])</span>
                                <span class="n">sleep_time</span> <span class="o">=</span> <span class="n">delta</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
                                <span class="n">sample_job_id</span> <span class="o">=</span> <span class="n">job_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sleep_time</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">sleep_time</span> <span class="o">+</span> <span class="n">increment</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">job_ids</span></div>

<div class="viewcode-block" id="AIOpsSQLClient.get_catalog_table_partitioned"><a class="viewcode-back" href="../../cloud_utilities.html#cloud_utilities.aiops.AIOpsSQLClient.get_catalog_table_partitioned">[docs]</a>    <span class="k">def</span> <span class="nf">get_catalog_table_partitioned</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                      <span class="n">table_name</span><span class="p">,</span>
                                      <span class="n">cos_url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                      <span class="n">prefix_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                      <span class="n">force_recreate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        table_name :str</span>
<span class="sd">            the name of the catalog table to be created</span>

<span class="sd">        cos_url : str, optional</span>
<span class="sd">            The COS URL from which the catalog table should reference to</span>
<span class="sd">            If not provided, it uses the internal `self.cos_in_url`</span>
<span class="sd">            IMPORTANT: Use only one of the two paramters `prefix_name` and `cos_url`</span>

<span class="sd">        prefix_name: str</span>
<span class="sd">            the prefix to be used, e.g. cos://&lt;cos-name&gt;/&lt;bucket&gt;/&lt;path&gt;/&lt;prefix-name&gt;</span>
<span class="sd">            If it is used, then the value of `cos_url` would be &quot;&lt;self.cos_out_url&gt;/`prefix_name`&quot;.</span>
<span class="sd">            IMPORTANT: Use only one of the two paramters `prefix_name` and `cos_url`</span>

<span class="sd">        force_recreate : bool, optional</span>
<span class="sd">            if True, delete (if existed) and recreate</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_catalog_table_name</span> <span class="o">=</span> <span class="n">table_name</span>

        <span class="k">if</span> <span class="n">cos_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cos_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cos_in_url_partitioned</span>
        <span class="k">if</span> <span class="n">prefix_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cos_url</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">cos_out_url</span><span class="p">,</span> <span class="n">prefix_name</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">cos_url</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;/&quot;</span><span class="p">:</span>
            <span class="n">cos_url</span> <span class="o">=</span> <span class="n">cos_url</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_catalog_tables</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">found</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;tableName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">table_name</span><span class="p">)]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># not found</span>
            <span class="n">found</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">force_recreate</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drop_catalog_table</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partitioned_tables</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">force_recreate</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">case</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># auto-detection of schema</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sql_stmt_create_partitioned_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                CREATE TABLE </span><span class="si">{table_name}</span><span class="s2"></span>
<span class="s2">                USING PARQUET</span>
<span class="s2">                LOCATION </span><span class="si">{cos_in}</span><span class="s2"></span>
<span class="s2">                &quot;&quot;&quot;</span>
                <span class="n">sql_stmt_create_partitioned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sql_stmt_create_partitioned_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">cos_in</span><span class="o">=</span><span class="n">cos_url</span><span class="p">)</span>
            <span class="c1"># explit selection of schema -&gt; need to tell &quot;PARTITIONED BY&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">case</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">sql_stmt_create_partitioned</span> <span class="o">=</span> \
                    <span class="sd">&quot;&quot;&quot;CREATE TABLE {table_name} (</span>
<span class="sd">                  Location string,</span>
<span class="sd">                  DC string,</span>
<span class="sd">                  gz_log_write_time string,</span>
<span class="sd">                  Year string,</span>
<span class="sd">                  Month string,</span>
<span class="sd">                  Day string,</span>
<span class="sd">                  container_id string,</span>
<span class="sd">                  container_name string,</span>
<span class="sd">                  object_length string,</span>
<span class="sd">                  request_method string,</span>
<span class="sd">                  request_latency float,</span>
<span class="sd">                  response_length float,</span>
<span class="sd">                  storage_account_id string,</span>
<span class="sd">                  timestamp_start timestamp,</span>
<span class="sd">                  timestamp_finish timestamp,</span>
<span class="sd">                  user_agent string</span>
<span class="sd">                  )</span>
<span class="sd">                  USING PARQUET</span>
<span class="sd">                  PARTITIONED BY (Location, DC, gz_log_write_time, Year, Month, Day) EVERY 1000000 ROWS</span>
<span class="sd">                  LOCATION {cos_in}&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">cos_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cos_in_url_partitioned_case01</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">case</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">sql_stmt_create_partitioned</span> <span class="o">=</span> \
                    <span class="sd">&quot;&quot;&quot;CREATE TABLE {table_name} (</span>
<span class="sd">                    gz_log_write_time string,</span>
<span class="sd">                    Year string,</span>
<span class="sd">                    Month string,</span>
<span class="sd">                    Day string,</span>
<span class="sd">                    container_id string,</span>
<span class="sd">                    container_name string,</span>
<span class="sd">                    object_length string,</span>
<span class="sd">                    request_method string,</span>
<span class="sd">                    request_latency float,</span>
<span class="sd">                    response_length float,</span>
<span class="sd">                    storage_account_id string,</span>
<span class="sd">                    timestamp_start timestamp,</span>
<span class="sd">                    timestamp_finish timestamp,</span>
<span class="sd">                    user_agent string</span>
<span class="sd">                    )</span>
<span class="sd">                    USING PARQUET</span>
<span class="sd">                    PARTITIONED BY (gz_log_write_time, Year, Month, Day) EVERY 1000000 ROWS</span>
<span class="sd">                    LOCATION {cos_in}&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">,</span> <span class="n">cos_in</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cos_in_url_partitioned_case02</span><span class="p">)</span>
            <span class="c1"># self.sqlClient.run_sql(sql_stmt_create_partitioned)</span>
            <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">submit_sql</span><span class="p">(</span><span class="n">sql_stmt_create_partitioned</span><span class="p">)</span>
            <span class="n">sql_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqlClient</span><span class="o">.</span><span class="n">wait_for_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">sql_status</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span>
                <span class="c1"># print_sql(sql_stmt_create_partitioned)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">sql_stmt_create_partitioned</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">refresh_cache_table_partitioned</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="AIOpsSQLClient.check_if_field_consistent"><a class="viewcode-back" href="../../cloud_utilities.html#cloud_utilities.aiops.AIOpsSQLClient.check_if_field_consistent">[docs]</a>    <span class="k">def</span> <span class="nf">check_if_field_consistent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="o">=</span><span class="s2">&quot;object_lifecycle&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; check if the data type of a given field is the same across data</span>
<span class="sd">        Compare day 1st with all other days in the month</span>

<span class="sd">        ======= principals</span>
<span class="sd">        Day [1]</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            {&#39;fields&#39;: [</span>
<span class="sd">                {&#39;name&#39;: &#39;aws&#39;, &#39;nullable&#39;: True, &#39;type&#39;: &#39;string&#39;},</span>
<span class="sd">                {&#39;name&#39;: &#39;identity&#39;, &#39;nullable&#39;: True, &#39;type&#39;: &#39;string&#39;},</span>
<span class="sd">                {&#39;name&#39;: &#39;username&#39;, &#39;nullable&#39;: True, &#39;type&#39;: &#39;string&#39;}],</span>
<span class="sd">            &#39;type&#39;: &#39;struct&#39;}</span>

<span class="sd">        Day [17-23]</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            {&#39;fields&#39;: [{&#39;name&#39;: &#39;aws&#39;, &#39;nullable&#39;: True, &#39;type&#39;: &#39;string&#39;},</span>
<span class="sd">                {&#39;name&#39;: &#39;identity&#39;, &#39;nullable&#39;: True, &#39;type&#39;: &#39;string&#39;}],</span>
<span class="sd">                &#39;type&#39;: &#39;struct&#39;}</span>

<span class="sd">        ======= object_lifecycle</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">                {&#39;fields&#39;: [</span>
<span class="sd">                        {&#39;name&#39;: &#39;expiration&#39;,</span>
<span class="sd">                        &#39;nested_type&#39;: {&#39;fields&#39;: [{&#39;name&#39;: &#39;expiration_time&#39;,</span>
<span class="sd">                            &#39;nullable&#39;: True,</span>
<span class="sd">                            &#39;type&#39;: &#39;string&#39;},</span>
<span class="sd">                            {&#39;name&#39;: &#39;rule_id&#39;, &#39;nullable&#39;: True, &#39;type&#39;: &#39;string&#39;},</span>
<span class="sd">                            {&#39;name&#39;: &#39;type&#39;, &#39;nullable&#39;: True, &#39;type&#39;: &#39;string&#39;}],</span>
<span class="sd">                            &#39;type&#39;: &#39;struct&#39;},</span>
<span class="sd">                        &#39;nullable&#39;: True},</span>
<span class="sd">                        {&#39;name&#39;: &#39;transition&#39;,</span>
<span class="sd">                        &#39;nested_type&#39;: {&#39;fields&#39;: [{&#39;name&#39;: &#39;archive&#39;,</span>
<span class="sd">                            &#39;nested_type&#39;: {&#39;fields&#39;: [{&#39;name&#39;: &#39;transition_class&#39;,</span>
<span class="sd">                                &#39;nullable&#39;: True,</span>
<span class="sd">                                &#39;type&#39;: &#39;string&#39;},</span>
<span class="sd">                                {&#39;name&#39;: &#39;transition_time&#39;, &#39;nullable&#39;: True, &#39;type&#39;: &#39;string&#39;},</span>
<span class="sd">                                {&#39;name&#39;: &#39;type&#39;, &#39;nullable&#39;: True, &#39;type&#39;: &#39;string&#39;}],</span>
<span class="sd">                            &#39;type&#39;: &#39;struct&#39;},</span>
<span class="sd">                            &#39;nullable&#39;: True}],</span>
<span class="sd">                            &#39;type&#39;: &#39;struct&#39;},</span>
<span class="sd">                        &#39;nullable&#39;: True}],</span>
<span class="sd">                &#39;type&#39;: &#39;struct&#39;</span>
<span class="sd">                }</span>

<span class="sd">                {&#39;fields&#39;: [</span>
<span class="sd">                    {&#39;name&#39;: &#39;expiration&#39;,</span>
<span class="sd">                    &#39;nested_type&#39;: {&#39;fields&#39;: [{&#39;name&#39;: &#39;expiration_time&#39;,</span>
<span class="sd">                        &#39;nullable&#39;: True,</span>
<span class="sd">                        &#39;type&#39;: &#39;string&#39;},</span>
<span class="sd">                        {&#39;name&#39;: &#39;rule_id&#39;, &#39;nullable&#39;: True, &#39;type&#39;: &#39;string&#39;},</span>
<span class="sd">                        {&#39;name&#39;: &#39;type&#39;, &#39;nullable&#39;: True, &#39;type&#39;: &#39;string&#39;}],</span>
<span class="sd">                        &#39;type&#39;: &#39;struct&#39;},</span>
<span class="sd">                    &#39;nullable&#39;: True},</span>
<span class="sd">                    {&#39;name&#39;: &#39;transition&#39;,</span>
<span class="sd">                    &#39;nested_type&#39;: {&#39;fields&#39;: [{&#39;name&#39;: &#39;archive&#39;,</span>
<span class="sd">                        &#39;nested_type&#39;: {&#39;fields&#39;: [{&#39;name&#39;: &#39;restore_expiration_time&#39;,</span>
<span class="sd">                            &#39;nullable&#39;: True,</span>
<span class="sd">                            &#39;type&#39;: &#39;string&#39;},</span>
<span class="sd">                --&gt;         {&#39;name&#39;: &#39;restored_storage_class&#39;, &#39;nullable&#39;: True, &#39;type&#39;: &#39;string&#39;},</span>
<span class="sd">                --&gt;         {&#39;name&#39;: &#39;restored_time&#39;, &#39;nullable&#39;: True, &#39;type&#39;: &#39;string&#39;},</span>
<span class="sd">                --&gt;         {&#39;name&#39;: &#39;transition_class&#39;, &#39;nullable&#39;: True, &#39;type&#39;: &#39;string&#39;},</span>
<span class="sd">                            {&#39;name&#39;: &#39;transition_time&#39;, &#39;nullable&#39;: True, &#39;type&#39;: &#39;string&#39;},</span>
<span class="sd">                            {&#39;name&#39;: &#39;type&#39;, &#39;nullable&#39;: True, &#39;type&#39;: &#39;string&#39;}],</span>
<span class="sd">                        &#39;type&#39;: &#39;struct&#39;},</span>
<span class="sd">                        &#39;nullable&#39;: True}],</span>
<span class="sd">                        &#39;type&#39;: &#39;struct&#39;},</span>
<span class="sd">                    &#39;nullable&#39;: True}],</span>
<span class="sd">                &#39;type&#39;: &#39;struct&#39;</span>
<span class="sd">                }</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cos_url</span> <span class="o">=</span> <span class="s2">&quot;cos://us-south/cos-analytics-parquet/AccessLogs/Location=us-south/DC=rgdal10/gz_log_write_time=2020-02-01-01/&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">sqlClient</span><span class="o">.</span><span class="n">get_schema_data</span><span class="p">(</span><span class="n">cos_url</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;parquet&quot;</span><span class="p">)</span>
        <span class="n">ref_dict</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span>
            <span class="n">field_name</span><span class="p">)][</span><span class="s2">&quot;nested_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">30</span><span class="p">):</span>
            <span class="n">cos_url</span> <span class="o">=</span> <span class="s2">&quot;cos://us-south/cos-analytics-parquet/AccessLogs/Location=us-south/DC=rgdal10/gz_log_write_time=2020-02-01-</span><span class="si">{}</span><span class="s2">/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">sqlClient</span><span class="o">.</span><span class="n">get_schema_data</span><span class="p">(</span><span class="n">cos_url</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;parquet&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ref_dict</span> <span class="o">!=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">field_name</span><span class="p">)]</span>
                <span class="p">[</span><span class="s2">&quot;nested_type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">day</span><span class="p">)</span></div>

    <span class="c1"># def append_where(self, where_clause):</span>
    <span class="c1">#     &quot;&quot;&quot;append the where clause&quot;&quot;&quot;</span>
    <span class="c1">#     def decorator(f):</span>
    <span class="c1">#         @functools.wraps(f)</span>
    <span class="c1">#         def wrapper(*args, **kw):</span>
    <span class="c1">#             print(where_clause)</span>
    <span class="c1">#             # return f(where_clause, *args, **kw)</span>
    <span class="c1">#             # if has_permissions(user_id):</span>
    <span class="c1">#             #     return f(*args, **kw)</span>
    <span class="c1">#             # else:</span>
    <span class="c1">#             #     # what do you want to do if there aren&#39;t permissions?</span>
    <span class="c1">#             #     pass</span>
    <span class="c1">#         return wrapper</span>
    <span class="c1">#     return decorator</span>

<div class="viewcode-block" id="AIOpsSQLClient.get_ts_datasource_by_rows"><a class="viewcode-back" href="../../cloud_utilities.html#cloud_utilities.aiops.AIOpsSQLClient.get_ts_datasource_by_rows">[docs]</a>    <span class="k">def</span> <span class="nf">get_ts_datasource_by_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">time_stamp</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span>
                <span class="n">cos_out</span><span class="p">,</span> <span class="n">granularity</span><span class="o">=</span><span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="n">where_clause</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">ops</span><span class="o">=</span><span class="s2">&quot;avg&quot;</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">num_rows</span><span class="o">=</span><span class="mi">1000000</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the data source for time-series in the next-query, in that the result is</span>
<span class="sd">        broken down into multiple objects using `num_rows` as the criteria</span>

<span class="sd">        It will returns the data source in 3 columns:</span>
<span class="sd">        &lt;key&gt;, time_stamp, observation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unixtime_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;timestamp_finish&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp_start&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ts_datasource</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">time_stamp</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span>
                <span class="n">cos_out</span><span class="p">,</span> <span class="n">granularity</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">num_rows</span><span class="o">=</span><span class="n">num_rows</span><span class="p">)</span></div>

<div class="viewcode-block" id="AIOpsSQLClient.get_ts_datasource"><a class="viewcode-back" href="../../cloud_utilities.html#cloud_utilities.aiops.AIOpsSQLClient.get_ts_datasource">[docs]</a>    <span class="k">def</span> <span class="nf">get_ts_datasource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">time_stamp</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span>
                <span class="n">cos_out</span><span class="p">,</span> <span class="n">granularity</span><span class="o">=</span><span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="n">where_clause</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">ops</span><span class="o">=</span><span class="s2">&quot;avg&quot;</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">num_objects</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the data source for time-series in the next-query, in that the result is</span>
<span class="sd">        broken down into multiple objects using `num_objects` as the criteria</span>

<span class="sd">        It will returns the data source in 3 columns:</span>
<span class="sd">        &lt;key&gt;, time_stamp, observation</span>

<span class="sd">        Parameters:</span>
<span class="sd">        --------------</span>
<span class="sd">        table: str</span>
<span class="sd">            The catalog table name</span>
<span class="sd">        key: str</span>
<span class="sd">            The column name being used as the key</span>
<span class="sd">        time_stamp: str</span>
<span class="sd">            The column name being used as timestick</span>
<span class="sd">        observation: str</span>
<span class="sd">            The column name being used as value</span>
<span class="sd">        cos_out: str</span>
<span class="sd">            The COS URL where the data is copied to - later as data source</span>
<span class="sd">        granularity: str</span>
<span class="sd">            a value in one of [&quot;raw&quot;, &quot;per_min&quot;, &quot;per_&lt;x&gt;min&quot;, &quot;per_sec&quot;, &quot;per_&lt;x&gt;sec&quot;]</span>
<span class="sd">            with &lt;x&gt; is a number divided by 60, e.g. 10, 15</span>

<span class="sd">        Returns</span>
<span class="sd">        ----------</span>
<span class="sd">        str</span>
<span class="sd">            The COS_URL where the data with 3 fields (key, time_stamp, observation)</span>
<span class="sd">            and can be digested into time-series via TIME_SERIES_FORMAT(key, timestick, value)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unixtime_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;timestamp_finish&quot;</span><span class="p">,</span> <span class="s2">&quot;timestamp_start&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ts_datasource</span><span class="p">(</span><span class="n">table_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">time_stamp</span><span class="p">,</span> <span class="n">observation</span><span class="p">,</span>
                <span class="n">cos_out</span><span class="p">,</span> <span class="n">granularity</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">,</span> <span class="n">num_objects</span><span class="o">=</span><span class="n">num_objects</span><span class="p">)</span>


        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">col_name	data_type</span>
<span class="sd">0	bucket_protection	struct&lt;permanent_retention_enabled:boolean,status:string&gt;</span>
<span class="sd">1	cloud_iam	struct&lt;crn:string,decision:string,is_failed:boolean,is_stale:boolean,is_throttling:boolean,num_attempts:bigint,op_code:string,pdp_elapsed_time:string,pdp_request_tx_id:string,subject:string,subject_ibm_id:string,subject_type:string&gt;</span>
<span class="sd">2	cloud_iam_copy_source	struct&lt;crn:string,decision:string,is_failed:boolean,is_stale:boolean,is_throttling:boolean,num_attempts:bigint,op_code:string,pdp_elapsed_time:string,pdp_request_tx_id:string&gt;</span>
<span class="sd">3	container_bytes_used	string</span>
<span class="sd">4	container_id	string</span>
<span class="sd">5	container_name	string</span>
<span class="sd">6	container_object_count	string</span>
<span class="sd">7	delete_marker	boolean</span>
<span class="sd">8	encryption_method	string</span>
<span class="sd">9	error_code	string</span>
<span class="sd">col_name	data_type</span>
<span class="sd">10	error_message	string</span>
<span class="sd">11	format	bigint</span>
<span class="sd">12	forwarded	string</span>
<span class="sd">13	https	struct&lt;cipher_suite:string,protocol:string&gt;</span>
<span class="sd">14	ibm_account_id	string</span>
<span class="sd">15	interface_type	string</span>
<span class="sd">16	is_secure	boolean</span>
<span class="sd">17	last_changed	string</span>
<span class="sd">18	last_modified	string</span>
<span class="sd">19	may_contain_non_active_bytes	boolean</span>
<span class="sd">col_name	data_type</span>
<span class="sd">20	midstream_error	string</span>
<span class="sd">21	notification_sent	boolean</span>
<span class="sd">22	object_count	bigint</span>
<span class="sd">23	object_length	string</span>
<span class="sd">24	object_lifecycle	struct&lt;expiration:struct&lt;expiration_time:string,rule_id:string,type:string&gt;,transition:struct&lt;archive:struct&lt;transition_class:string,transition_time:string,type:string&gt;&gt;&gt;</span>
<span class="sd">25	object_name	string</span>
<span class="sd">26	partial_storage_account_bytes_used	string</span>
<span class="sd">27	partial_storage_account_object_count	string</span>
<span class="sd">28	previous_last_modified	string</span>
<span class="sd">29	previous_object_length	string</span>
<span class="sd">col_name	data_type</span>
<span class="sd">30	principals	struct&lt;aws:string,identity:string,username:string&gt;</span>
<span class="sd">31	protocol	string</span>
<span class="sd">32	range	string</span>
<span class="sd">33	referer	string</span>
<span class="sd">34	remote_address	string</span>
<span class="sd">35	remote_user	string</span>
<span class="sd">36	remote_user_subject	string</span>
<span class="sd">37	request_id	string</span>
<span class="sd">38	request_latency	string</span>
<span class="sd">39	request_length	string</span>
<span class="sd">col_name	data_type</span>
<span class="sd">40	request_method	string</span>
<span class="sd">41	request_type	string</span>
<span class="sd">42	request_uri	string</span>
<span class="sd">43	requested_location_constraint	string</span>
<span class="sd">44	response_length	string</span>
<span class="sd">45	selective_logging_enabled	boolean</span>
<span class="sd">46	server_name	string</span>
<span class="sd">47	sse_kms	struct&lt;kms:struct&lt;code:bigint,correlation_id:string,endpoint:string,is_cached:boolean,latency:string,message:string,num_attempts:bigint,result:string&gt;,sit:struct&lt;latency:string,result:string&gt;&gt;</span>
<span class="sd">48	stat	struct&lt;client_wait:double,commit:double,digest:double,post_transfer:double,pre_transfer:double,storage_wait:double,total_transfer:double,turn_around_time:double&gt;</span>
<span class="sd">49	status	bigint</span>
<span class="sd">col_name	data_type</span>
<span class="sd">50	storage_account_id	string</span>
<span class="sd">51	storage_location_id	string</span>
<span class="sd">52	time_finish	string</span>
<span class="sd">53	time_start	string</span>
<span class="sd">54	timestamp_finish	string</span>
<span class="sd">55	timestamp_start	string</span>
<span class="sd">56	type	string</span>
<span class="sd">57	upload_id	string</span>
<span class="sd">58	user_agent	string</span>
<span class="sd">59	vault_name	string</span>
<span class="sd">col_name	data_type</span>
<span class="sd">60	version_name	string</span>
<span class="sd">61	version_transient	boolean</span>
<span class="sd">62	accesser_log_filename	string</span>
<span class="sd">63	forwarded_for	string</span>
<span class="sd">64	Time	timestamp</span>
<span class="sd">65	Minute	int</span>
<span class="sd">66	Second	int</span>
<span class="sd">67	PreviousObjectLength	double</span>
<span class="sd">68	ObjectLength	double</span>
<span class="sd">69	AccountType	string</span>
<span class="sd">col_name	data_type</span>
<span class="sd">70	EndpointRegion	string</span>
<span class="sd">71	EndpointType	string</span>
<span class="sd">72	Location	string</span>
<span class="sd">73	DC	string</span>
<span class="sd">74	Hour	int</span>
<span class="sd">75	# Partition Information	NaN</span>
<span class="sd">76	# col_name	data_type</span>
<span class="sd">77	Hour	int</span>
<span class="sd">col_name	data_type</span>
<span class="sd">col_name	data_type</span>

<span class="sd">struct&lt;ghost:struct&lt;code:bigint,endpoints:struct&lt;private_endpoint:string,public_endpoint:string&gt;,ghost_endpoint:string,ghost_instance:string,latency:string,message:string,num_attempts:bigint,result:string,transaction_id:string&gt;,kms:struct&lt;registration:struct&lt;code:bigint,correlation_id:string,crk_crn_status:string,endpoint:string,latency:string,message:string,num_attempts:bigint,request_method:string,result:string,time_start:string&gt;,unwrap:struct&lt;code:bigint,correlation_id:string,endpoint:string,is_cached:boolean,latency:string,message:string,num_attempts:bigint,request_method:string,result:string,time_start:string&gt;,wrap:struct&lt;code:bigint,correlation_id:string,crk_crn_status:string,endpoint:string,latency:string,message:string,num_attempts:bigint,request_method:string,result:string,time_start:string&gt;&gt;,sit:struct&lt;latency:string,result:string&gt;&gt; &lt;&gt; struct&lt;ghost:struct&lt;code:bigint,endpoints:struct&lt;private_endpoint:string,public_endpoint:string&gt;,ghost_endpoint:string,ghost_instance:string,latency:string,message:string,num_attempts:bigint,result:string,transaction_id:string&gt;,kms:struct&lt;deregistration:struct&lt;code:bigint,correlation_id:string,crk_crn_status:string,endpoint:string,latency:string,message:string,num_attempts:bigint,request_method:string,result:string,time_start:string&gt;,registration:struct&lt;code:bigint,correlation_id:string,crk_crn_status:string,endpoint:string,latency:string,message:string,num_attempts:bigint,request_method:string,result:string,time_start:string&gt;,unwrap:struct&lt;code:bigint,correlation_id:string,endpoint:string,is_cached:boolean,latency:string,message:string,num_attempts:bigint,request_method:string,result:string,time_start:string&gt;,wrap:struct&lt;code:bigint,correlation_id:string,crk_crn_status:string,endpoint:string,latency:string,message:string,num_attempts:bigint,request_method:string,result:string,time_start:string&gt;&gt;,sit:struct&lt;latency:string,result:string&gt;&gt;</span>

<span class="sd">struct&lt;default_retention:string,maximum_retention:string,minimum_retention:string,permanent_retention_enabled:boolean,status:string&gt; &lt;&gt; struct&lt;permanent_retention_enabled:boolean,status:string&gt;</span>

<span class="sd">struct&lt;crn:string,decision:string,is_failed:boolean,is_stale:boolean,is_throttling:boolean,num_attempts:bigint,op_code:string,pdp_elapsed_time:string,pdp_request_tx_id:string,pdp_status:bigint,subject:string,subject_ibm_id:string,subject_type:string&gt; &lt;&gt; struct&lt;crn:string,decision:string,is_failed:boolean,is_stale:boolean,is_throttling:boolean,num_attempts:bigint,op_code:string,pdp_elapsed_time:string,pdp_request_tx_id:string,subject:string,subject_ibm_id:string,subject_type:string&gt;</span>
<span class="sd">        &quot;&quot;&quot;</span></div></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="n">sqlClient</span> <span class="o">=</span> <span class="n">AIOpsSQLClient</span><span class="p">(</span><span class="n">cos_out_url</span><span class="o">=</span><span class="s2">&quot;cos://tuan-test/bucket&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hello world&quot;</span><span class="p">)</span>
    <span class="c1"># sqlClient.get_catalog_table_partitioned(&quot;aiops&quot;)</span>
    <span class="n">sql_template</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT storage_account_id, timestamp_finish, cast(request_latency as float) AS request_latency</span>
<span class="s2">FROM </span><span class="si">{cos_in}</span><span class="s2"></span>
<span class="s2">STORED AS PARQUET</span>
<span class="s2">WHERE isnotnull(storage_account_id) AND isnotnull(request_latency)</span>
<span class="s2">INTO </span><span class="si">{cos_out}</span><span class="s2"></span>
<span class="s2">&quot;&quot;&quot;</span>
    <span class="c1"># select_full_location = sqlClient.query_by_date(sql_template, date_info=&quot;20191023&quot;)</span>
    <span class="c1"># select_full_location = sqlClient.copy_into_hive_partitions_full_day(</span>
    <span class="c1">#     prefix_name=&quot;aiops&quot;, date_info=&quot;20191023&quot;, dry_run=True)</span>
    <span class="c1"># select_full_location = sqlClient.copy_into_hive_partitions_full_day(</span>
    <span class="c1">#     prefix_name=&quot;aiops&quot;,</span>
    <span class="c1">#     date_info=&quot;20191023&quot;,</span>
    <span class="c1">#     query_granularity=&quot;halfday&quot;,</span>
    <span class="c1">#     dry_run=True)</span>
    <span class="c1"># select_full_location = sqlClient.copy_into_hive_partitions_full_day_test(</span>
    <span class="c1">#     prefix_name=&quot;aiops&quot;, date_info=&quot;20191023&quot;, dry_run=True)</span>
    <span class="c1"># select_full_location = sqlClient.copy_into_hive_partitions_full_day(</span>
    <span class="c1">#     prefix_name=&quot;aiops&quot;,</span>
    <span class="c1">#     columns_list=&quot;*&quot;,</span>
    <span class="c1">#     date_info=&quot;20191023&quot;,</span>
    <span class="c1">#     dry_run=True)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FULL MONTH&quot;</span><span class="p">)</span>
    <span class="c1"># select_full_location = sqlClient.copy_into_hive_partitions_full_month(</span>
    <span class="c1">#     prefix_name=&quot;aiops&quot;, date_info=&quot;20200303&quot;, dry_run=True)</span>
    <span class="c1"># select_full_location = sqlClient.copy_into_hive_partitions_full_month(</span>
    <span class="c1">#     prefix_name=&quot;aiops&quot;, date_info=&quot;20191023&quot;, dry_run=True)</span>
    <span class="c1"># select_full_location = sqlClient.copy_into_hive_partitions_full_month(</span>
    <span class="c1">#     prefix_name=&quot;aiops&quot;,</span>
    <span class="c1">#     date_info=&quot;20191023&quot;,</span>
    <span class="c1">#     query_granularity=&quot;halfday&quot;,</span>
    <span class="c1">#     dry_run=True)</span>
    <span class="c1">#select_full_location = sqlClient.copy_into_hive_partitions_full_month(</span>
    <span class="c1">#    prefix_name=&quot;aiops_us_south_rgdal10_202002&quot;,</span>
    <span class="c1">#    columns_list=&quot;*&quot;,</span>
    <span class="c1">#    except_columns_list=[&quot;object_lifecycle&quot;, &quot;principals&quot;],</span>
    <span class="c1">#    location=&quot;us-south&quot;,</span>
    <span class="c1">#    DC=&quot;rgdal10&quot;,</span>
    <span class="c1">#    date_info=&quot;20200201&quot;,</span>
    <span class="c1">#    dry_run=True)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FULL YEAR&quot;</span><span class="p">)</span>
    <span class="c1"># select_full_location = sqlClient.copy_into_hive_partitions_full_year(</span>
    <span class="c1">#     prefix_name=&quot;aiops&quot;,</span>
    <span class="c1">#     date_info=&quot;2020&quot;,</span>
    <span class="c1">#     query_granularity=&quot;perhour&quot;,</span>
    <span class="c1">#     dry_run=True)</span>
    <span class="c1"># select_full_location = sqlClient.copy_into_hive_partitions_full_year(</span>
    <span class="c1">#     prefix_name=&quot;aiops&quot;,</span>
    <span class="c1">#     date_info=&quot;20200123&quot;,</span>
    <span class="c1">#     query_granularity=&quot;perhour&quot;,</span>
    <span class="c1">#     dry_run=True)</span>
    <span class="c1"># select_full_location = sqlClient.copy_into_hive_partitions_full_year(</span>
    <span class="c1">#     prefix_name=&quot;aiops&quot;,</span>
    <span class="c1">#     date_info=&quot;20191123&quot;,</span>
    <span class="c1">#     query_granularity=&quot;perhour&quot;,</span>
    <span class="c1">#     dry_run=True)</span>

    <span class="n">where_clause</span> <span class="o">=</span> <span class="s2">&quot;YEAR=2020 and Month=03&quot;</span>
    <span class="c1"># sqlClient.append_where(where_clause=where_clause)(</span>
    <span class="c1">#     sqlClient.get_ts_datasource(table_name=&quot;aiops&quot;, key=&quot;storage_account_id&quot;,</span>
    <span class="c1">#         time_stamp=&quot;timestamp_finish&quot;, observation=&quot;request_latency&quot;, cos_out=&quot;cos://aaa&quot;, granularity=&quot;per_2sec&quot;, dry_run=True)</span>
    <span class="c1"># )</span>
    <span class="n">sqlClient</span><span class="o">.</span><span class="n">get_ts_datasource</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;aiops&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;storage_account_id&quot;</span><span class="p">,</span>
        <span class="n">time_stamp</span><span class="o">=</span><span class="s2">&quot;timestamp_finish&quot;</span><span class="p">,</span> <span class="n">observation</span><span class="o">=</span><span class="s2">&quot;request_latency&quot;</span><span class="p">,</span> <span class="n">cos_out</span><span class="o">=</span><span class="s2">&quot;cos://aaa&quot;</span><span class="p">,</span> <span class="n">granularity</span><span class="o">=</span><span class="s2">&quot;per_2sec&quot;</span><span class="p">,</span>
        <span class="n">where_clause</span><span class="o">=</span><span class="n">where_clause</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">sqlClient</span><span class="o">.</span><span class="n">get_ts_datasource_by_rows</span><span class="p">(</span><span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;aiops&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;storage_account_id&quot;</span><span class="p">,</span>
        <span class="n">time_stamp</span><span class="o">=</span><span class="s2">&quot;timestamp_finish&quot;</span><span class="p">,</span> <span class="n">observation</span><span class="o">=</span><span class="s2">&quot;request_latency&quot;</span><span class="p">,</span> <span class="n">cos_out</span><span class="o">=</span><span class="s2">&quot;cos://aaa&quot;</span><span class="p">,</span> <span class="n">granularity</span><span class="o">=</span><span class="s2">&quot;per_2sec&quot;</span><span class="p">,</span>
        <span class="n">where_clause</span><span class="o">=</span><span class="n">where_clause</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &copy;2020, IBM Research.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>